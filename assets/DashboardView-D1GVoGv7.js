import{d as fe,k as me,u as be,l as ye,r as k,n as A,o as ke,Z as we,_ as X,c as b,f as l,q as m,s as I,e as t,w as r,g as M,p as ee,t as d,$ as Te,b as Ae,i as h,a0 as te,S as $,y as w,T as Y,a1 as R,a2 as U,a3 as $e,a4 as se,a5 as ae,B as De,a6 as Ce,a7 as le,I as Me,G as J,Q as j,a8 as O,h as u,U as Se,v as Pe}from"./index-wT8oNPsL.js";import{u as Fe}from"./ticket-VzGyKyZH.js";import{_ as ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ne={class:"dashboard"},qe={class:"stat-card stat-card-danger"},Be={class:"stat-content"},Ee={class:"stat-value"},Ie={class:"stat-label"},Ye={class:"stat-icon"},Re={class:"stat-card stat-card-primary"},Ue={class:"stat-content"},Ve={class:"stat-value"},xe={class:"stat-label"},Qe={class:"stat-icon"},Le={class:"stat-card stat-card-warning"},Je={class:"stat-content"},je={class:"stat-value"},Oe={class:"stat-label"},Ge={class:"stat-icon"},He={class:"stat-card stat-card-success"},Ze={class:"stat-content"},Ke={class:"stat-value"},We={class:"stat-label"},Xe={class:"stat-icon"},et={class:"quick-actions-section"},tt={class:"section-title"},st={class:"sla-alert-section"},at={class:"section-title"},lt={key:0,class:"sla-alert-list"},ot={class:"alert-content"},nt={class:"alert-title"},rt={class:"alert-desc"},dt={class:"alert-time"},it={key:1,class:"no-alerts"},ct={class:"chart-section"},ut={class:"chart-header"},vt={class:"section-title"},ht={class:"chart-tabs"},gt={class:"chart-placeholder"},_t={class:"trend-chart"},pt={class:"bar-label"},ft={class:"chart-section"},mt={class:"chart-header"},bt={class:"section-title"},yt={class:"chart-subtitle"},kt={class:"chart-placeholder"},wt={key:0,class:"pie-chart-placeholder"},Tt={class:"pie-legend"},At={class:"legend-label"},$t={class:"legend-value"},Dt={key:1,class:"no-data"},Ct={class:"latest-tickets-section"},Mt={class:"section-header"},St={class:"section-title"},Pt=fe({__name:"DashboardView",setup(Ft){const oe=Ae(),{t:_}=me(),z=be();Fe();const ne=ye(),V=k(!1),G=k([]),y=k([]),C=k("monthly"),S=A(()=>z.isAdmin),N=A(()=>z.isManager),re=A(()=>z.user?.role==="support_staff"),H=A(()=>S.value||N.value),Z=A(()=>S.value||N.value||re.value),x=k([]),Q=k([0,0,0,0,0,0]),q=k([]),P=k([]),p=k({open:0,inProgress:0,overdue:0,resolved:0}),F=k({open:0,inProgress:0,overdue:0,resolved:0}),f=A(()=>{const e=(s,o)=>o===0?s>0?100:0:+((s-o)/o*100).toFixed(1);return{openTickets:e(p.value.open,F.value.open),inProgressTickets:e(p.value.inProgress,F.value.inProgress),overdueTickets:e(p.value.overdue,F.value.overdue),resolvedToday:e(p.value.resolved,F.value.resolved)}}),B=A(()=>({openTickets:p.value.open,inProgressTickets:p.value.inProgress,overdueTickets:p.value.overdue,resolvedToday:p.value.resolved})),de=A(()=>{if(P.value.length===0)return{};let e=[],s=0;return P.value.forEach(o=>{const c=s+o.value/100*360;e.push(`${o.color} ${s}deg ${c}deg`),s=c}),{background:`conic-gradient(${e.join(", ")})`}});ke(async()=>{ne.setBreadcrumbs([{label:_("nav.dashboard")}]),V.value=!0;try{await ce(),G.value=y.value.slice(0,5),ue(),ve(),K(),Z.value&&he()}finally{V.value=!1}}),we(C,()=>{K()});function ie(e){return{...e,createdAt:e.createdAt||e.created_at,updatedAt:e.updatedAt||e.updated_at,resolvedAt:e.resolvedAt||e.resolved_at,closedAt:e.closedAt||e.closed_at,requesterId:e.requesterId||e.requester_id,requesterName:e.requesterName||e.requester_name,assigneeId:e.assigneeId||e.assignee_id,assigneeName:e.assigneeName||e.assignee_name,teamId:e.teamId||e.team_id,teamName:e.teamName||e.team_name,slaBreached:e.slaBreached??e.sla_breached??!1,slaResponseDeadline:e.slaResponseDeadline||e.sla_response_deadline,slaResolutionDeadline:e.slaResolutionDeadline||e.sla_resolution_deadline}}async function ce(){try{let e;if(console.log("User role check - isAdmin:",S.value,"isManager:",N.value,"user:",z.user),S.value||N.value?(console.log("Fetching all tickets as admin/manager"),e=await X.getTickets({page:1,pageSize:100})):(console.log("Fetching my tickets as regular user"),e=await X.getMyTickets({page:1,pageSize:100})),console.log("Tickets API raw response:",e),console.log("Response data:",e.data),e.code===200&&e.data){const s=e.data.items||e.data.results||e.data;console.log("Extracted items:",s);const o=Array.isArray(s)?s:[];y.value=o.map(ie),console.log("Normalized tickets:",y.value.length),y.value.length>0&&console.log("Sample normalized ticket:",y.value[0])}else console.error("API returned non-200 code or no data:",e)}catch(e){console.error("Failed to load tickets for stats:",e),y.value=[]}}function ue(){const e=y.value,s=new Date,o=new Date(s.getFullYear(),s.getMonth(),s.getDate()),c=new Date(o.getTime()-1440*60*1e3),v=o;p.value={open:e.filter(n=>["new","assigned"].includes(n.status)).length,inProgress:e.filter(n=>n.status==="in_progress").length,overdue:e.filter(n=>n.slaBreached).length,resolved:e.filter(n=>["resolved","closed"].includes(n.status)?new Date(n.updatedAt||n.createdAt)>=o:!1).length},e.filter(n=>new Date(n.createdAt)<v),F.value={open:Math.max(0,p.value.open-e.filter(n=>new Date(n.createdAt)>=o&&["new","assigned"].includes(n.status)).length),inProgress:Math.max(0,p.value.inProgress-e.filter(n=>new Date(n.createdAt)>=o&&n.status==="in_progress").length),overdue:Math.max(0,p.value.overdue-1),resolved:e.filter(n=>{if(!["resolved","closed"].includes(n.status))return!1;const a=new Date(n.updatedAt||n.createdAt);return a>=c&&a<v}).length}}function ve(){const e=y.value,s=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#9C27B0","#00BCD4"],o={};e.forEach(n=>{const a=n.category?.name||"Uncategorized";o[a]=(o[a]||0)+1});const c=e.length||1,v=Object.entries(o).map(([n,a],g)=>({name:n,value:Math.round(a/c*100),color:s[g%s.length]})).sort((n,a)=>a.value-n.value).slice(0,6);if(v.length>0){const n=v.reduce((a,g)=>a+g.value,0);n!==100&&n>0&&v[0]&&(v[0].value+=100-n)}P.value=v}function K(){const e=y.value,s=new Date;if(console.log("Calculating ticket trend, total tickets:",e.length),e.length>0&&e[0]&&console.log("First ticket createdAt:",e[0].createdAt,"parsed:",new Date(e[0].createdAt||"")),C.value==="monthly"){const o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],c=[],v=[];for(let a=5;a>=0;a--){const g=new Date(s.getFullYear(),s.getMonth()-a,1),E=new Date(g.getFullYear(),g.getMonth(),1),i=new Date(g.getFullYear(),g.getMonth()+1,0,23,59,59);console.log(`Month: ${o[g.getMonth()]}, Start: ${E}, End: ${i}`);const T=e.filter(pe=>{const W=new Date(pe.createdAt);return W>=E&&W<=i}).length;v.push(T),c.push(o[g.getMonth()]||"N/A")}console.log("Monthly counts:",v,"labels:",c);const n=Math.max(...v,1);Q.value=v.map(a=>a===0?0:Math.max(Math.round(a/n*100),5)),q.value=c}else{const o=["Q1","Q2","Q3","Q4"],c=[0,0,0,0];e.forEach(n=>{const a=new Date(n.createdAt);if(a.getFullYear()===s.getFullYear()){const g=Math.floor(a.getMonth()/3);g>=0&&g<c.length&&(c[g]=(c[g]||0)+1)}}),console.log("Quarterly counts:",c);const v=Math.max(...c,1);Q.value=[...c.map(n=>n===0?0:Math.max(Math.round(n/v*100),5)),0,0],q.value=[...o,"",""]}}function he(){const e=y.value,s=[];let o=1;e.filter(a=>a.slaBreached).forEach(a=>{s.push({id:o++,type:"danger",title:_("dashboard.slaBreached"),description:a.title.substring(0,50)+(a.title.length>50?"...":""),time:_("dashboard.overdue")})}),e.filter(a=>a.priority==="urgent"&&["new","assigned","in_progress"].includes(a.status)&&!a.slaBreached).forEach(a=>{s.push({id:o++,type:"warning",title:_("tickets.priorityUrgent"),description:a.title.substring(0,50)+(a.title.length>50?"...":""),time:_("dashboard.urgentTicketAlert")})}),e.filter(a=>a.priority==="high"&&["new","assigned"].includes(a.status)&&!a.slaBreached).slice(0,2).forEach(a=>{s.push({id:o++,type:"info",title:_("tickets.priorityHigh"),description:a.title.substring(0,50)+(a.title.length>50?"...":""),time:_("dashboard.awaitingAssignment")})}),x.value=s.slice(0,5)}function D(e){oe.push(e)}function ge(e){return{new:_("tickets.statusNew"),assigned:_("tickets.statusAssigned"),in_progress:_("tickets.statusInProgress"),pending_user:_("tickets.statusPendingUser"),resolved:_("tickets.statusResolved"),closed:_("tickets.statusClosed"),cancelled:"Cancelled"}[e]||e}function _e(e){return e.charAt(0).toUpperCase()+e.slice(1)}function L(e,s){return e>0?s?"up bad":"up good":e<0?s?"down good":"down bad":"neutral"}return(e,s)=>{const o=M("el-icon"),c=M("el-col"),v=M("el-row"),n=M("el-button"),a=M("el-table-column"),g=M("el-table"),E=Te("loading");return u(),b("div",Ne,[l(v,{gutter:20,class:"stats-row"},{default:r(()=>[l(c,{xs:12,sm:6},{default:r(()=>[t("div",qe,[t("div",Be,[t("div",Ee,d(B.value.openTickets),1),t("div",Ie,d(e.$t("dashboard.openTickets")),1)]),t("div",Ye,[l(o,{size:24,color:"#f56c6c"},{default:r(()=>[l(h(te))]),_:1})]),t("div",{class:$(["stat-change",L(f.value.openTickets,!0)])},[l(o,null,{default:r(()=>[(u(),m(Y(f.value.openTickets>=0?h(R):h(U))))]),_:1}),w(" "+d(Math.abs(f.value.openTickets).toFixed(1))+"% "+d(e.$t("dashboard.fromYesterday")),1)],2)])]),_:1}),l(c,{xs:12,sm:6},{default:r(()=>[t("div",Re,[t("div",Ue,[t("div",Ve,d(B.value.inProgressTickets),1),t("div",xe,d(e.$t("dashboard.inProgress")),1)]),t("div",Qe,[l(o,{size:24,color:"#409eff"},{default:r(()=>[l(h($e))]),_:1})]),t("div",{class:$(["stat-change",f.value.inProgressTickets>=0?"up neutral":"down neutral"])},[l(o,null,{default:r(()=>[(u(),m(Y(f.value.inProgressTickets>=0?h(R):h(U))))]),_:1}),w(" "+d(Math.abs(f.value.inProgressTickets).toFixed(1))+"% "+d(e.$t("dashboard.fromYesterday")),1)],2)])]),_:1}),l(c,{xs:12,sm:6},{default:r(()=>[t("div",Le,[t("div",Je,[t("div",je,d(B.value.overdueTickets),1),t("div",Oe,d(e.$t("dashboard.overdue")),1)]),t("div",Ge,[l(o,{size:24,color:"#e6a23c"},{default:r(()=>[l(h(se))]),_:1})]),t("div",{class:$(["stat-change",L(f.value.overdueTickets,!0)])},[l(o,null,{default:r(()=>[(u(),m(Y(f.value.overdueTickets>=0?h(R):h(U))))]),_:1}),w(" "+d(Math.abs(f.value.overdueTickets).toFixed(1))+"% "+d(e.$t("dashboard.fromYesterday")),1)],2)])]),_:1}),l(c,{xs:12,sm:6},{default:r(()=>[t("div",He,[t("div",Ze,[t("div",Ke,d(B.value.resolvedToday),1),t("div",We,d(e.$t("dashboard.resolvedToday")),1)]),t("div",Xe,[l(o,{size:24,color:"#67c23a"},{default:r(()=>[l(h(ae))]),_:1})]),t("div",{class:$(["stat-change",L(f.value.resolvedToday,!1)])},[l(o,null,{default:r(()=>[(u(),m(Y(f.value.resolvedToday>=0?h(R):h(U))))]),_:1}),w(" "+d(Math.abs(f.value.resolvedToday).toFixed(1))+"% "+d(e.$t("dashboard.fromYesterday")),1)],2)])]),_:1})]),_:1}),l(v,{gutter:20,class:"actions-row"},{default:r(()=>[l(c,{xs:24,lg:14},{default:r(()=>[t("div",et,[t("h3",tt,d(e.$t("dashboard.quickActions")),1),l(v,{gutter:16},{default:r(()=>[l(c,{span:12},{default:r(()=>[t("div",{class:"action-card action-card-blue",onClick:s[0]||(s[0]=i=>D("/tickets/create"))},[l(o,{size:24},{default:r(()=>[l(h(De))]),_:1}),s[7]||(s[7]=t("span",null,"create",-1))])]),_:1}),l(c,{span:12},{default:r(()=>[t("div",{class:"action-card action-card-green",onClick:s[1]||(s[1]=i=>D("/knowledge"))},[l(o,{size:24},{default:r(()=>[l(h(Ce))]),_:1}),s[8]||(s[8]=t("span",null,"search knowledge",-1))])]),_:1}),H.value?(u(),m(c,{key:0,span:12},{default:r(()=>[t("div",{class:"action-card action-card-pink",onClick:s[2]||(s[2]=i=>D("/admin/analytics"))},[l(o,{size:24},{default:r(()=>[l(h(le))]),_:1}),s[9]||(s[9]=t("span",null,"analytics",-1))])]),_:1})):I("",!0),S.value?(u(),m(c,{key:1,span:12},{default:r(()=>[t("div",{class:"action-card action-card-purple",onClick:s[3]||(s[3]=i=>D("/admin/users"))},[l(o,{size:24},{default:r(()=>[l(h(Me))]),_:1}),s[10]||(s[10]=t("span",null,"user management",-1))])]),_:1})):I("",!0)]),_:1})])]),_:1}),Z.value?(u(),m(c,{key:0,xs:24,lg:10},{default:r(()=>[t("div",st,[t("h3",at,d(e.$t("dashboard.slaAlert")),1),x.value.length>0?(u(),b("div",lt,[(u(!0),b(J,null,j(x.value,i=>(u(),b("div",{key:i.id,class:"sla-alert-item"},[t("div",{class:$(["alert-icon",i.type])},[i.type==="danger"?(u(),m(o,{key:0},{default:r(()=>[l(h(te))]),_:1})):i.type==="warning"?(u(),m(o,{key:1},{default:r(()=>[l(h(se))]),_:1})):(u(),m(o,{key:2},{default:r(()=>[l(h(Se))]),_:1}))],2),t("div",ot,[t("div",nt,d(i.title),1),t("div",rt,d(i.description),1)]),t("div",dt,d(i.time),1)]))),128))])):(u(),b("div",it,[l(o,{size:32,color:"#67c23a"},{default:r(()=>[l(h(ae))]),_:1}),t("p",null,d(e.$t("dashboard.noSLAAlerts")),1)]))])]),_:1})):I("",!0)]),_:1}),H.value?(u(),m(v,{key:0,gutter:20,class:"charts-row"},{default:r(()=>[l(c,{xs:24,lg:14},{default:r(()=>[t("div",ct,[t("div",ut,[t("h3",vt,d(e.$t("dashboard.ticketTrend")),1),t("div",ht,[t("span",{class:$(["tab",{active:C.value==="monthly"}]),onClick:s[4]||(s[4]=i=>C.value="monthly")},d(e.$t("dashboard.monthly")),3),t("span",{class:$(["tab",{active:C.value==="quarterly"}]),onClick:s[5]||(s[5]=i=>C.value="quarterly")},d(e.$t("dashboard.quarterly")),3)])]),t("div",gt,[t("div",_t,[(u(!0),b(J,null,j(Q.value,(i,T)=>ee((u(),b("div",{key:T,class:"bar-wrapper"},[t("div",{class:"bar",style:O({height:i+"%"})},null,4),t("span",pt,d(q.value[T]),1)])),[[Pe,q.value[T]]])),128))])])])]),_:1}),l(c,{xs:24,lg:10},{default:r(()=>[t("div",ft,[t("div",mt,[t("h3",bt,d(e.$t("dashboard.categoryDistribution")),1),t("span",yt,d(e.$t("dashboard.allTickets")),1)]),t("div",kt,[P.value.length>0?(u(),b("div",wt,[t("div",{class:"pie-chart",style:O(de.value)},null,4),t("div",Tt,[(u(!0),b(J,null,j(P.value,(i,T)=>(u(),b("div",{class:"legend-item",key:T},[t("span",{class:"legend-color",style:O({background:i.color})},null,4),t("span",At,d(i.name),1),t("span",$t,d(i.value)+"%",1)]))),128))])])):(u(),b("div",Dt,[l(o,{size:48,color:"#909399"},{default:r(()=>[l(h(le))]),_:1}),t("p",null,d(e.$t("common.noData")),1)]))])])]),_:1})]),_:1})):I("",!0),t("div",Ct,[t("div",Mt,[t("h3",St,d(e.$t("dashboard.latestTickets")),1),l(n,{text:"",type:"primary",onClick:s[6]||(s[6]=i=>D("/tickets"))},{default:r(()=>[w(d(e.$t("dashboard.viewAll")),1)]),_:1})]),ee((u(),m(g,{data:G.value,style:{width:"100%"},class:"latest-tickets-table"},{default:r(()=>[l(a,{prop:"id",label:e.$t("dashboard.ticketNo"),width:"160"},null,8,["label"]),l(a,{prop:"requesterName",label:e.$t("dashboard.customer"),width:"120"},{default:r(()=>[...s[11]||(s[11]=[w("xxx",-1)])]),_:1},8,["label"]),l(a,{prop:"category",label:e.$t("common.category"),"min-width":"140"},{default:r(({row:i})=>[w(d(i.category?.name||"N/A"),1)]),_:1},8,["label"]),l(a,{prop:"priority",label:e.$t("common.priority"),width:"100"},{default:r(({row:i})=>[w(d(_e(i.priority)),1)]),_:1},8,["label"]),l(a,{prop:"status",label:e.$t("common.status"),width:"120"},{default:r(({row:i})=>[t("span",{class:$(["status-text",`status-${i.status}`])},d(ge(i.status)),3)]),_:1},8,["label"]),l(a,{label:e.$t("dashboard.operation"),width:"160"},{default:r(({row:i})=>[l(n,{text:"",type:"primary",size:"small",onClick:T=>D(`/tickets/${i.id}`)},{default:r(()=>[w(d(e.$t("dashboard.detailed")),1)]),_:1},8,["onClick"]),l(n,{text:"",type:"primary",size:"small",onClick:T=>D(`/tickets/${i.id}`)},{default:r(()=>[w(d(e.$t("dashboard.process")),1)]),_:1},8,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[E,V.value]])])])}}}),Bt=ze(Pt,[["__scopeId","data-v-ff2c6e5c"]]);export{Bt as default};
