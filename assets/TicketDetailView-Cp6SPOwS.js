import{d as Ue,k as De,u as Ne,l as Re,p as $,r as _,o as ze,a as Pe,a0 as ce,s as Fe,a2 as Me,c as f,x as k,y as g,J as V,e as i,f as a,w as t,g as m,t as l,i as r,A as u,ad as qe,Y as Ee,T as N,K as He,a7 as Le,M as Ge,ae as Oe,E as v,b as je,h as d,N as Je,V as Ke,af as Ye,ag as Qe,ah as We}from"./index-Bo1QE9TC.js";import{u as Xe}from"./ticket-Cd9x3L1M.js";import{g as ue,f as E,a as Ze,b as xe,c as et,d as tt}from"./helpers-BtQK9j-g.js";import{_ as at}from"./_plugin-vue_export-helper-DlAUqK2U.js";const st={class:"ticket-detail-view"},lt={class:"page-header"},ot={class:"header-left"},nt={key:0,class:"header-right"},it={style:{"text-align":"right"}},ct={class:"satisfaction-survey"},ut={class:"survey-description"},rt={class:"rating-section"},dt={class:"rating-label"},mt={class:"feedback-section"},ft={style:{"text-align":"right"}},vt={class:"ticket-title"},pt={class:"ticket-meta"},_t={class:"ticket-description"},gt={key:0,class:"attachments-section"},kt={class:"attachment-list"},yt=["href"],ht={class:"attachment-size"},bt={class:"card-header"},wt={class:"comments-list"},$t={class:"comment-header"},St={class:"comment-author"},Tt={class:"author-name"},Vt={class:"comment-time"},Ct={class:"comment-content"},At={class:"add-comment"},Bt={class:"comment-actions"},It={class:"history-item"},Ut={class:"history-change"},Dt={class:"history-by"},Nt={key:0,class:"history-comment"},Rt={key:0,class:"satisfaction-display"},zt={class:"rating-display"},Pt={class:"label"},Ft={key:0,class:"feedback-display"},Mt={class:"label"},qt={class:"feedback-text"},Et={key:1,class:"satisfaction-prompt"},Ht={key:2,class:"satisfaction-pending"},Lt=Ue({__name:"TicketDetailView",setup(Gt){const O=Pe(),re=je(),{t:n}=De(),p=Xe(),S=Ne(),j=Re(),J=$(()=>p.loading),s=$(()=>p.currentTicket),K=$(()=>S.isStaff),de=$(()=>S.isAdmin),me=$(()=>S.isManager),Y=$(()=>!s.value||!S.user?!1:String(s.value.requesterId)===String(S.user.id)),w=_(!1),Q=_([]),W=_([]),R=_(null),z=_(null),C=_(!1),A=_(""),P=_(!1),H=_(!1),B=_(!1),I=_(0),F=_(""),L=_(!1),fe=$(()=>[n("common.veryPoor")||"Very Poor",n("common.poor")||"Poor",n("common.average")||"Average",n("common.good")||"Good",n("common.excellent")||"Excellent"]);function M(e){return{new:n("tickets.statusNew"),assigned:n("tickets.statusAssigned"),in_progress:n("tickets.statusInProgress"),pending_user:n("tickets.statusPendingUser"),resolved:n("tickets.statusResolved"),closed:n("tickets.statusClosed")}[e]||e}ze(async()=>{const e=O.params.id;await p.fetchTicketById(e),s.value&&j.setBreadcrumbs([{label:n("nav.dashboard"),path:"/"},{label:n("nav.tickets"),path:"/my-tickets"},{label:s.value.id}])}),ce(()=>O.params.id,async e=>{e&&(await p.fetchTicketById(e),s.value&&j.setBreadcrumbs([{label:n("nav.dashboard"),path:"/"},{label:n("nav.tickets"),path:"/my-tickets"},{label:s.value.id}]))});function X(){re.back()}function ve(e){return e.split(" ").map(c=>c[0]).join("").toUpperCase().slice(0,2)}async function pe(e){if(s.value){if(e==="assign_other"){await _e();return}if(e==="assigned"){await ye();return}try{const{value:c}=await Ye.prompt(n("tickets.statusChangeComment"),n("tickets.changeStatus"),{confirmButtonText:n("common.confirm"),cancelButtonText:n("common.cancel"),inputType:"textarea"}),y=await p.updateTicketStatus(s.value.id,e,c);y.success?v.success(n("tickets.statusUpdated")):v.error(y.message||n("errors.operationFailed"))}catch{}}}async function _e(){w.value=!0,await ge(),await ke()}async function ge(){try{const e=await Qe.getUsers({page:1,pageSize:200,role:"support_staff"});e.code===200&&e.data&&(Q.value=e.data.items||[])}catch(e){console.error("Load assignees error",e)}}async function ke(){try{const e=await We.getTeams();e.code===200&&e.data&&(W.value=e.data)}catch(e){console.error("Load teams error",e)}}async function ye(){if(!s.value)return;const e=S.user?.id;if(!e){v.error(n("errors.notAuthenticated"));return}C.value=!0;try{const c=await p.assignTicket(s.value.id,String(e));c.success?(v.success(n("tickets.ticketAssigned")),await p.fetchTicketById(s.value.id)):v.error(c.message||n("errors.operationFailed"))}finally{C.value=!1}}async function he(){if(s.value){C.value=!0;try{if(z.value){const e=await p.assignTicketToTeam(s.value.id,z.value);if(e.success){v.success(n("tickets.ticketAssigned")),w.value=!1,await p.fetchTicketById(s.value.id);return}else{v.error(e.message||n("errors.operationFailed"));return}}if(R.value){const e=await p.assignTicket(s.value.id,R.value);if(e.success){v.success(n("tickets.ticketAssigned")),w.value=!1,await p.fetchTicketById(s.value.id);return}else{v.error(e.message||n("errors.operationFailed"));return}}v.warning(n("tickets.selectAssigneeOrTeam"))}finally{C.value=!1}}}async function Z(){if(!s.value||!A.value.trim()){v.warning(n("tickets.enterComment"));return}H.value=!0;try{const e=await p.addComment(s.value.id,A.value,P.value);e.success?(v.success(n("tickets.commentAdded")),A.value="",P.value=!1):v.error(e.message||n("errors.operationFailed"))}finally{H.value=!1}}function x(){I.value=0,F.value="",B.value=!0}async function be(){if(s.value){if(I.value===0){v.warning(n("tickets.ratingRequired"));return}L.value=!0;try{const e=await p.submitSatisfaction(s.value.id,I.value,F.value||void 0);e.success?(v.success(n("tickets.feedbackSubmitted")),B.value=!1):v.error(e.message||n("errors.operationFailed"))}finally{L.value=!1}}}return ce(()=>s.value?.status,(e,c)=>{e==="closed"&&c==="resolved"&&Y.value&&(s.value?.satisfactionRating||x())}),(e,c)=>{const y=m("el-icon"),h=m("el-button"),U=m("el-tag"),T=m("el-dropdown-item"),we=m("el-dropdown-menu"),$e=m("el-dropdown"),ee=m("el-option"),te=m("el-select"),G=m("el-form-item"),ae=m("el-form"),se=m("el-dialog"),le=m("el-rate"),oe=m("el-input"),ne=m("el-divider"),D=m("el-card"),Se=m("el-avatar"),q=m("el-empty"),Te=m("el-checkbox"),ie=m("el-col"),b=m("el-descriptions-item"),Ve=m("el-descriptions"),Ce=m("el-timeline-item"),Ae=m("el-timeline"),Be=m("el-row"),Ie=Me("loading");return Fe((d(),f("div",st,[s.value?(d(),f(V,{key:0},[i("div",lt,[i("div",ot,[a(h,{text:"",onClick:X},{default:t(()=>[a(y,null,{default:t(()=>[a(r(qe))]),_:1}),u(" "+l(e.$t("common.back")),1)]),_:1}),i("h1",null,l(s.value.id),1),a(U,{type:r(ue)(s.value.status),size:"large"},{default:t(()=>[u(l(M(s.value.status)),1)]),_:1},8,["type"]),s.value.slaBreached?(d(),k(U,{key:0,type:"danger",size:"large"},{default:t(()=>[...c[10]||(c[10]=[u(" SLA ",-1)])]),_:1})):g("",!0)]),K.value?(d(),f("div",nt,[a($e,{onCommand:pe},{dropdown:t(()=>[a(we,null,{default:t(()=>[a(T,{command:"assigned",disabled:s.value.status==="assigned"},{default:t(()=>[u(l(e.$t("tickets.assignToMe")),1)]),_:1},8,["disabled"]),de.value||me.value?(d(),k(T,{key:0,command:"assign_other"},{default:t(()=>[u(l(e.$t("tickets.assignTicket")),1)]),_:1})):g("",!0),a(T,{command:"in_progress",disabled:s.value.status==="in_progress"},{default:t(()=>[u(l(e.$t("tickets.statusInProgress")),1)]),_:1},8,["disabled"]),a(T,{command:"pending_user",disabled:s.value.status==="pending_user"},{default:t(()=>[u(l(e.$t("tickets.statusPendingUser")),1)]),_:1},8,["disabled"]),a(T,{command:"resolved",disabled:s.value.status==="resolved"},{default:t(()=>[u(l(e.$t("tickets.markResolved")),1)]),_:1},8,["disabled"]),a(T,{command:"closed",disabled:s.value.status==="closed"},{default:t(()=>[u(l(e.$t("tickets.closeTicket")),1)]),_:1},8,["disabled"])]),_:1})]),default:t(()=>[a(h,{type:"primary"},{default:t(()=>[u(l(e.$t("tickets.changeStatus"))+" ",1),a(y,{class:"el-icon--right"},{default:t(()=>[a(r(Ee))]),_:1})]),_:1})]),_:1})])):g("",!0)]),a(se,{title:r(n)("tickets.assignTicket"),modelValue:w.value,"onUpdate:modelValue":c[3]||(c[3]=o=>w.value=o),width:"480px","before-close":()=>{w.value=!1}},{footer:t(()=>[i("div",it,[a(h,{onClick:c[2]||(c[2]=o=>w.value=!1)},{default:t(()=>[u(l(r(n)("common.cancel")),1)]),_:1}),a(h,{type:"primary",loading:C.value,onClick:he},{default:t(()=>[u(l(r(n)("common.confirm")),1)]),_:1},8,["loading"])])]),default:t(()=>[a(ae,{"label-position":"top"},{default:t(()=>[a(G,{label:r(n)("tickets.selectAssignee")},{default:t(()=>[a(te,{modelValue:R.value,"onUpdate:modelValue":c[0]||(c[0]=o=>R.value=o),placeholder:"Select user",filterable:"",clearable:""},{default:t(()=>[(d(!0),f(V,null,N(Q.value,o=>(d(),k(ee,{key:o.id,label:o.name||o.email,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),a(G,{label:r(n)("tickets.selectTeam")},{default:t(()=>[a(te,{modelValue:z.value,"onUpdate:modelValue":c[1]||(c[1]=o=>z.value=o),placeholder:"Select team",filterable:"",clearable:""},{default:t(()=>[(d(!0),f(V,null,N(W.value,o=>(d(),k(ee,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"])]),_:1})]),_:1},8,["title","modelValue","before-close"]),a(se,{title:r(n)("tickets.satisfactionSurvey"),modelValue:B.value,"onUpdate:modelValue":c[7]||(c[7]=o=>B.value=o),width:"500px","close-on-click-modal":!1},{footer:t(()=>[i("div",ft,[a(h,{onClick:c[6]||(c[6]=o=>B.value=!1)},{default:t(()=>[u(l(r(n)("common.cancel")),1)]),_:1}),a(h,{type:"primary",loading:L.value,onClick:be},{default:t(()=>[u(l(r(n)("tickets.submitRating")),1)]),_:1},8,["loading"])])]),default:t(()=>[i("div",ct,[i("p",ut,l(r(n)("tickets.satisfactionSurveyDesc")),1),i("div",rt,[i("label",dt,l(r(n)("tickets.satisfactionRating")),1),a(le,{modelValue:I.value,"onUpdate:modelValue":c[4]||(c[4]=o=>I.value=o),texts:fe.value,"show-text":"",size:"large"},null,8,["modelValue","texts"])]),i("div",mt,[a(oe,{modelValue:F.value,"onUpdate:modelValue":c[5]||(c[5]=o=>F.value=o),type:"textarea",rows:4,placeholder:r(n)("tickets.feedbackPlaceholder")},null,8,["modelValue","placeholder"])])])]),_:1},8,["title","modelValue"]),a(Be,{gutter:24},{default:t(()=>[a(ie,{xs:24,lg:16},{default:t(()=>[a(D,{class:"info-card"},{default:t(()=>[i("h2",vt,l(s.value.title),1),i("div",pt,[i("span",null,[a(y,null,{default:t(()=>[a(r(He))]),_:1}),u(" "+l(s.value.requesterName),1)]),i("span",null,[a(y,null,{default:t(()=>[a(r(Le))]),_:1}),u(" "+l(r(E)(s.value.createdAt,"datetime")),1)]),i("span",null,[a(y,null,{default:t(()=>[a(r(Ge))]),_:1}),u(" "+l(s.value.category?.name||"General"),1)])]),a(ne),i("div",_t,[i("h3",null,l(e.$t("common.description")),1),i("p",null,l(s.value.description),1)]),s.value.attachments&&s.value.attachments.length>0?(d(),f("div",gt,[i("h3",null,l(e.$t("tickets.attachments")),1),i("div",kt,[(d(!0),f(V,null,N(s.value.attachments,o=>(d(),f("a",{key:o.id,class:"attachment-item",href:o.url,target:"_blank"},[a(y,null,{default:t(()=>[a(r(Je))]),_:1}),i("span",null,l(o.filename),1),i("span",ht,l(r(et)(o.fileSize)),1)],8,yt))),128))])])):g("",!0)]),_:1}),a(D,{class:"comments-card"},{header:t(()=>[i("div",bt,[i("span",null,l(e.$t("tickets.comments"))+" ("+l(s.value.comments?.length||0)+")",1)])]),default:t(()=>[i("div",wt,[(d(!0),f(V,null,N(s.value.comments,o=>(d(),f("div",{key:o.id,class:Ke(["comment-item",{internal:o.isInternal}])},[i("div",$t,[i("div",St,[a(Se,{size:32},{default:t(()=>[u(l(ve(o.authorName)),1)]),_:2},1024),i("span",Tt,l(o.authorName),1),o.isInternal?(d(),k(U,{key:0,type:"warning",size:"small"},{default:t(()=>[u(l(e.$t("tickets.internalNote")),1)]),_:1})):g("",!0)]),i("span",Vt,l(r(tt)(o.createdAt)),1)]),i("div",Ct,l(o.content),1)],2))),128)),s.value.comments?.length?g("",!0):(d(),k(q,{key:0,description:e.$t("tickets.noComments")},null,8,["description"]))]),i("div",At,[a(ne),a(ae,{onSubmit:Oe(Z,["prevent"])},{default:t(()=>[a(G,null,{default:t(()=>[a(oe,{modelValue:A.value,"onUpdate:modelValue":c[8]||(c[8]=o=>A.value=o),type:"textarea",rows:3,placeholder:e.$t("tickets.addCommentPlaceholder")},null,8,["modelValue","placeholder"])]),_:1}),i("div",Bt,[K.value?(d(),k(Te,{key:0,modelValue:P.value,"onUpdate:modelValue":c[9]||(c[9]=o=>P.value=o)},{default:t(()=>[u(l(e.$t("tickets.internalNoteDesc")),1)]),_:1},8,["modelValue"])):g("",!0),a(h,{type:"primary",onClick:Z,loading:H.value},{default:t(()=>[u(l(e.$t("tickets.addComment")),1)]),_:1},8,["loading"])])]),_:1})])]),_:1})]),_:1}),a(ie,{xs:24,lg:8},{default:t(()=>[a(D,{class:"details-card"},{header:t(()=>[i("span",null,l(e.$t("tickets.ticketDetails")),1)]),default:t(()=>[a(Ve,{column:1,border:""},{default:t(()=>[a(b,{label:e.$t("common.status")},{default:t(()=>[a(U,{type:r(ue)(s.value.status)},{default:t(()=>[u(l(M(s.value.status)),1)]),_:1},8,["type"])]),_:1},8,["label"]),a(b,{label:e.$t("common.priority")},{default:t(()=>[a(U,{type:r(Ze)(s.value.priority),effect:"plain"},{default:t(()=>[u(l(r(xe)(s.value.priority)),1)]),_:1},8,["type"])]),_:1},8,["label"]),a(b,{label:e.$t("common.category")},{default:t(()=>[u(l(s.value.category?.name||"General"),1)]),_:1},8,["label"]),a(b,{label:e.$t("tickets.channel")},{default:t(()=>[u(l(s.value.channel),1)]),_:1},8,["label"]),a(b,{label:e.$t("tickets.requester")},{default:t(()=>[u(l(s.value.requesterName),1)]),_:1},8,["label"]),a(b,{label:e.$t("common.email")},{default:t(()=>[u(l(s.value.requesterEmail),1)]),_:1},8,["label"]),a(b,{label:e.$t("tickets.assignee")},{default:t(()=>[u(l(s.value.assigneeName||e.$t("tickets.unassigned")),1)]),_:1},8,["label"]),a(b,{label:e.$t("common.created")},{default:t(()=>[u(l(r(E)(s.value.createdAt,"datetime")),1)]),_:1},8,["label"]),a(b,{label:e.$t("common.updated")},{default:t(()=>[u(l(r(E)(s.value.updatedAt,"datetime")),1)]),_:1},8,["label"])]),_:1})]),_:1}),a(D,{class:"history-card"},{header:t(()=>[i("span",null,l(e.$t("tickets.statusHistory")),1)]),default:t(()=>[a(Ae,null,{default:t(()=>[(d(!0),f(V,null,N(s.value.statusHistory,o=>(d(),k(Ce,{key:o.id,timestamp:r(E)(o.changedAt,"datetime"),placement:"top"},{default:t(()=>[i("div",It,[i("span",Ut,l(M(o.previousStatus))+" â†’ "+l(M(o.newStatus)),1),i("span",Dt,"by "+l(o.changedBy),1),o.comment?(d(),f("p",Nt,l(o.comment),1)):g("",!0)])]),_:2},1032,["timestamp"]))),128))]),_:1}),s.value.statusHistory?.length?g("",!0):(d(),k(q,{key:0,description:e.$t("tickets.noHistory"),"image-size":60},null,8,["description"]))]),_:1}),s.value.status==="closed"?(d(),k(D,{key:0,class:"satisfaction-card"},{header:t(()=>[i("span",null,l(e.$t("tickets.satisfactionSurvey")),1)]),default:t(()=>[s.value.satisfactionRating?(d(),f("div",Rt,[i("div",zt,[i("span",Pt,l(e.$t("tickets.yourRating"))+":",1),a(le,{"model-value":s.value.satisfactionRating,disabled:""},null,8,["model-value"])]),s.value.satisfactionComment?(d(),f("div",Ft,[i("span",Mt,l(e.$t("tickets.yourFeedback"))+":",1),i("p",qt,l(s.value.satisfactionComment),1)])):g("",!0)])):Y.value?(d(),f("div",Et,[i("p",null,l(e.$t("tickets.satisfactionSurveyDesc")),1),a(h,{type:"primary",onClick:x},{default:t(()=>[u(l(e.$t("tickets.submitRating")),1)]),_:1})])):(d(),f("div",Ht,[a(q,{description:e.$t("tickets.noHistory"),"image-size":40},null,8,["description"])]))]),_:1})):g("",!0)]),_:1})]),_:1})],64)):J.value?g("",!0):(d(),k(q,{key:1,description:e.$t("tickets.ticketNotFound")},{default:t(()=>[a(h,{type:"primary",onClick:X},{default:t(()=>[u(l(e.$t("knowledge.goBack")),1)]),_:1})]),_:1},8,["description"]))])),[[Ie,J.value]])}}}),Yt=at(Lt,[["__scopeId","data-v-4e7ef2d3"]]);export{Yt as default};
